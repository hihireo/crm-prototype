import React, { useState } from "react";
import CustomerInfoModal from "../components/CustomerInfoModal";
import "./ConsultationPage.css";

const ConsultationPage = ({ user, service }) => {
  const [selectedChat, setSelectedChat] = useState(null);
  const [newMessage, setNewMessage] = useState("");
  const [isCustomerModalOpen, setIsCustomerModalOpen] = useState(false);
  const [aiMessage, setAiMessage] = useState("");
  const [aiChatHistory, setAiChatHistory] = useState([]);

  // Î©îÏã†Ï†ÄÎ≥Ñ Ï±ÑÌåÖ Î™©Î°ù
  const [conversations, setConversations] = useState([
    {
      id: 1,
      platform: "telegram",
      platformName: "ÌÖîÎ†àÍ∑∏Îû®",
      customerName: "Ìà¨ÏûêÏôï",
      customerId: "31073160",
      lastMessage: "ÏïàÎÖïÌïòÏÑ∏Ïöî",
      timestamp: "Aug 20, 4:20:00 PM",
      unreadCount: 1,
      status: "New Lead",
      avatar: "S",
      messages: [
        {
          id: 1,
          sender: "customer",
          content: "ÏïàÎÖïÌïòÏÑ∏Ïöî",
          timestamp: "Aug 20, 4:20:00 PM",
          type: "text",
        },
      ],
    },
    {
      id: 2,
      platform: "instagram",
      platformName: "Ïù∏Ïä§ÌÉÄÍ∑∏Îû®",
      customerName: "ÍπÄÏòÅÌù¨",
      customerId: "younghee_kim",
      lastMessage: "ÏßÄÌëú Í¥ÄÎ†® Î¨∏Ïùò ÎìúÎ†§Ïöî",
      timestamp: "Aug 20, 3:45:00 PM",
      unreadCount: 3,
      status: "Hot Lead",
      avatar: "ÍπÄ",
      messages: [
        {
          id: 1,
          sender: "customer",
          content: "ÏßÄÌëú Í¥ÄÎ†® Î¨∏Ïùò ÎìúÎ†§Ïöî",
          timestamp: "Aug 20, 3:40:00 PM",
          type: "text",
        },
        {
          id: 2,
          sender: "customer",
          content: "ÏßÄÌëú Ïù¥Ïö©Î£åÍ∞Ä Ïñ¥ÎñªÍ≤å ÎêòÎÇòÏöî?",
          timestamp: "Aug 20, 3:42:00 PM",
          type: "text",
        },
        {
          id: 3,
          sender: "customer",
          content: "ÏÇ¨Ïö©ÌïòÍ≥† Ïã∂Ïñ¥Ïöî",
          timestamp: "Aug 20, 3:45:00 PM",
          type: "text",
        },
      ],
    },
    {
      id: 3,
      platform: "line",
      platformName: "ÎùºÏù∏",
      customerName: "Î∞ïÏ≤†Ïàò",
      customerId: "chulsoo_park",
      lastMessage: "Î∞îÎ°ú Îê©ÎãàÎã§. Í∞êÏÇ¨Ìï©ÎãàÎã§!",
      timestamp: "Aug 20, 2:15:00 PM",
      unreadCount: 0,
      status: "Customer",
      avatar: "Î∞ï",
      messages: [
        {
          id: 1,
          sender: "agent",
          content: "ÏïàÎÖïÌïòÏÑ∏Ïöî! Î¨∏Ïùò Ï£ºÏã† ÎÇ¥Ïö© Í¥ÄÎ†®Ìï¥ÏÑú Ïó∞ÎùΩÎìúÎ¶ΩÎãàÎã§.",
          timestamp: "Aug 20, 2:10:00 PM",
          type: "text",
        },
        {
          id: 2,
          sender: "customer",
          content: "ÎÑ§ ÏïàÎÖïÌïòÏÑ∏Ïöî",
          timestamp: "Aug 20, 2:12:00 PM",
          type: "text",
        },
        {
          id: 3,
          sender: "agent",
          content:
            "ÏöîÏ≤≠ÌïòÏã† Ï°∞Í±¥Ïóê ÎßûÎäî ÏÉÅÌíàÏùÑ Ï∞æÏïòÏäµÎãàÎã§. Ïñ∏Ï†ú ÏãúÍ∞Ñ ÎêòÏã§ÍπåÏöî?",
          timestamp: "Aug 20, 2:13:00 PM",
          type: "text",
        },
        {
          id: 4,
          sender: "customer",
          content: "Î∞îÎ°ú Îê©ÎãàÎã§. Í∞êÏÇ¨Ìï©ÎãàÎã§!",
          timestamp: "Aug 20, 2:15:00 PM",
          type: "text",
        },
      ],
    },
    {
      id: 4,
      platform: "telegram",
      platformName: "ÌÖîÎ†àÍ∑∏Îû®",
      customerName: "Ïù¥ÎØºÏàò",
      customerId: "minsu_lee",
      lastMessage: "ÏÉÅÎã¥ ÏòàÏïΩÌïòÍ≥† Ïã∂Ïñ¥Ïöî",
      timestamp: "Aug 20, 1:30:00 PM",
      unreadCount: 2,
      status: "New Lead",
      avatar: "Ïù¥",
      messages: [
        {
          id: 1,
          sender: "customer",
          content: "ÏïàÎÖïÌïòÏÑ∏Ïöî",
          timestamp: "Aug 20, 1:25:00 PM",
          type: "text",
        },
        {
          id: 2,
          sender: "customer",
          content: "ÏÉÅÎã¥ ÏòàÏïΩÌïòÍ≥† Ïã∂Ïñ¥Ïöî",
          timestamp: "Aug 20, 1:30:00 PM",
          type: "text",
        },
      ],
    },
  ]);

  const handleSendMessage = () => {
    if (newMessage.trim() && selectedChat) {
      const newMsg = {
        id: selectedChat.messages.length + 1,
        sender: "agent",
        content: newMessage,
        timestamp: new Date().toLocaleString(),
        type: "text",
      };

      // conversations ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
      setConversations((prev) =>
        prev.map((conv) =>
          conv.id === selectedChat.id
            ? {
                ...conv,
                messages: [...conv.messages, newMsg],
                lastMessage: newMessage,
                timestamp: new Date().toLocaleString(),
              }
            : conv
        )
      );

      // selectedChat ÏÉÅÌÉúÎèÑ ÎèôÏãúÏóê ÏóÖÎç∞Ïù¥Ìä∏ÌïòÏó¨ Î©îÏù∏ Ï±ÑÌåÖ ÌôîÎ©¥Ïóê Ïã§ÏãúÍ∞Ñ Î∞òÏòÅ
      setSelectedChat((prev) => ({
        ...prev,
        messages: [...prev.messages, newMsg],
        lastMessage: newMessage,
        timestamp: new Date().toLocaleString(),
      }));

      setNewMessage("");
    }
  };

  const handleSendAiMessage = () => {
    if (aiMessage.trim()) {
      const userMsg = {
        id: aiChatHistory.length + 1,
        sender: "user",
        content: aiMessage,
        timestamp: new Date().toLocaleString(),
      };

      // ÏÇ¨Ïö©Ïûê Î©îÏãúÏßÄ Ï∂îÍ∞Ä
      setAiChatHistory((prev) => [...prev, userMsg]);

      // AI ÏùëÎãµ ÏãúÎÆ¨Î†àÏù¥ÏÖò (Ïã§Ï†úÎ°úÎäî API Ìò∏Ï∂ú)
      setTimeout(() => {
        const aiResponse = {
          id: aiChatHistory.length + 2,
          sender: "ai",
          content: `"${aiMessage}"Ïóê ÎåÄÌïú AI ÏùëÎãµÏûÖÎãàÎã§. Ïù¥ Î∂ÄÎ∂ÑÏóêÏÑú Ïã§Ï†ú AI APIÏôÄ Ïó∞ÎèôÌïòÏó¨ ÎãµÎ≥ÄÏùÑ Î∞õÏùÑ Ïàò ÏûàÏäµÎãàÎã§.`,
          timestamp: new Date().toLocaleString(),
        };
        setAiChatHistory((prev) => [...prev, aiResponse]);
      }, 1000);

      setAiMessage("");
    }
  };

  const getPlatformIcon = (platform) => {
    switch (platform) {
      case "telegram":
        return (
          <img
            src="/images/platforms/telegram_logo.png"
            alt="Telegram"
            className="platform-icon"
          />
        );
      case "instagram":
        return (
          <img
            src="/images/platforms/Instagram_logo.png"
            alt="Instagram"
            className="platform-icon"
          />
        );
      case "line":
        return (
          <img
            src="/images/platforms/line_logo.png"
            alt="Line"
            className="platform-icon"
          />
        );
      default:
        return "üí¨";
    }
  };

  // eslint-disable-next-line no-unused-vars
  const getStatusColor = (status) => {
    switch (status) {
      case "New Lead":
        return "status-new";
      case "Hot Lead":
        return "status-hot";
      case "Customer":
        return "status-customer";
      case "Payment":
        return "status-payment";
      default:
        return "status-new";
    }
  };

  const filteredConversations = conversations.sort(
    (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
  );

  return (
    <div className="consultation-page">
      <div className="consultation-layout">
        {/* Ï±ÑÌåÖ Î™©Î°ù ÏÇ¨Ïù¥ÎìúÎ∞î */}
        <div className="chat-sidebar">
          <div className="sidebar-header">
            <h2>ÏÉÅÎã¥ Ï±ÑÌåÖ</h2>
            <div className="chat-stats">
              <span>Ï¥ù {conversations.length}Í±¥</span>
              <span>
                ÎØ∏ÏùΩÏùå{" "}
                {conversations.reduce((sum, conv) => sum + conv.unreadCount, 0)}
                Í±¥
              </span>
            </div>
          </div>

          <div className="platform-filters">
            <button className="platform-filter active">Ï†ÑÏ≤¥</button>
            <button className="platform-filter">
              <img
                src="/images/platforms/telegram_logo.png"
                alt="Telegram"
                className="filter-icon"
              />
            </button>
            <button className="platform-filter">
              <img
                src="/images/platforms/Instagram_logo.png"
                alt="Instagram"
                className="filter-icon"
              />
            </button>
            <button className="platform-filter">
              <img
                src="/images/platforms/line_logo.png"
                alt="Line"
                className="filter-icon"
              />
            </button>
          </div>

          <div className="chat-list">
            {filteredConversations.map((conversation) => (
              <div
                key={conversation.id}
                className={`chat-item ${
                  selectedChat?.id === conversation.id ? "active" : ""
                }`}
                onClick={() => {
                  // Ï±ÑÌåÖÎ∞© ÏÑ†ÌÉùÏãú Ìï¥Îãπ Ï±ÑÌåÖÎ∞©Ïùò ÏùΩÏßÄ ÏïäÏùÄ Î©îÏãúÏßÄ Ïπ¥Ïö¥Ìä∏Î•º 0ÏúºÎ°ú ÏÑ§Ï†ï
                  const updatedConversation = {
                    ...conversation,
                    unreadCount: 0,
                  };
                  setSelectedChat(updatedConversation);

                  // conversations ÏÉÅÌÉúÏóêÏÑúÎèÑ Ìï¥Îãπ Ï±ÑÌåÖÎ∞©Ïùò unreadCountÎ•º 0ÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
                  setConversations((prev) =>
                    prev.map((conv) =>
                      conv.id === conversation.id
                        ? { ...conv, unreadCount: 0 }
                        : conv
                    )
                  );
                }}
              >
                <div className="chat-avatar-section">
                  <div className="chat-avatar">{conversation.avatar}</div>
                </div>

                <div className="chat-info">
                  <div className="chat-header">
                    <div className="customer-name-with-icon">
                      <span className="customer-name">
                        {conversation.customerName}
                      </span>
                      <span className="platform-badge">
                        {getPlatformIcon(conversation.platform)}
                      </span>
                    </div>
                    <span className="chat-time">
                      {conversation.timestamp.split(" ").slice(-2).join(" ")}
                    </span>
                  </div>
                  <div className="chat-preview">
                    <span className="last-message">
                      {conversation.lastMessage}
                    </span>
                    {conversation.unreadCount > 0 && (
                      <span className="unread-count">
                        {conversation.unreadCount}
                      </span>
                    )}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Ï±ÑÌåÖ Î©îÏù∏ ÏòÅÏó≠ */}
        <div className="chat-main">
          {selectedChat ? (
            <>
              {/* Ï±ÑÌåÖ Ìó§Îçî */}
              <div className="chat-header-section">
                <div className="customer-info">
                  <div className="customer-avatar">{selectedChat.avatar}</div>
                  <div className="customer-details">
                    <div className="customer-title-with-icon">
                      <h3>{selectedChat.customerName}</h3>
                      <span className="platform-badge-header">
                        {getPlatformIcon(selectedChat.platform)}
                      </span>
                    </div>
                    <p>ID: {selectedChat.customerId}</p>
                  </div>
                </div>
                <div className="chat-actions">
                  <button
                    className="btn btn-secondary"
                    onClick={() => setIsCustomerModalOpen(true)}
                  >
                    Í≥†Í∞ù Ï†ïÎ≥¥
                  </button>
                  <button className="btn btn-primary">Î∞∞Ï†ïÌïòÍ∏∞</button>
                </div>
              </div>

              {/* Î©îÏãúÏßÄ ÏòÅÏó≠ */}
              <div className="messages-container">
                {selectedChat.messages.map((message) => (
                  <div
                    key={message.id}
                    className={`message ${
                      message.sender === "agent" ? "sent" : "received"
                    }`}
                  >
                    <div className="message-content">
                      <p>{message.content}</p>
                      <span className="message-time">{message.timestamp}</span>
                    </div>
                  </div>
                ))}
              </div>

              {/* Î©îÏãúÏßÄ ÏûÖÎ†• ÏòÅÏó≠ */}
              <div className="message-input-section">
                <div className="input-tools">
                  <button className="tool-btn">üìé</button>
                  <button className="tool-btn">üòä</button>
                  <button className="tool-btn">üñºÔ∏è</button>
                </div>
                <div className="message-input-area">
                  <input
                    type="text"
                    className="message-input"
                    placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                    value={newMessage}
                    onChange={(e) => setNewMessage(e.target.value)}
                    onKeyPress={(e) => e.key === "Enter" && handleSendMessage()}
                  />
                  <button
                    className="send-button"
                    onClick={handleSendMessage}
                    disabled={!newMessage.trim()}
                  >
                    Ï†ÑÏÜ°
                  </button>
                </div>
              </div>
            </>
          ) : (
            <div className="no-chat-selected">
              <div className="empty-state">
                <h3>Ï±ÑÌåÖÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</h3>
                <p>ÏôºÏ™Ω Î™©Î°ùÏóêÏÑú ÏÉÅÎã¥Ìï† Í≥†Í∞ùÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
              </div>
            </div>
          )}
        </div>

        {/* Í≥†Í∞ù Ï†ïÎ≥¥ ÏÇ¨Ïù¥ÎìúÎ∞î */}
        {selectedChat && (
          <div className="customer-sidebar">
            {/* Í≥†Í∞ù Ï†ïÎ≥¥ ÏòÅÏó≠ - Ï∂ïÏÜåÎê® */}
            <div className="customer-profile">
              <div className="profile-header-compact">
                <div className="consultation-profile-avatar-small">
                  {selectedChat.avatar}
                </div>
                <div className="profile-info-compact">
                  <h4>{selectedChat.customerName}</h4>
                  <span className="platform-badge-sidebar">
                    {getPlatformIcon(selectedChat.platform)}
                  </span>
                </div>
              </div>

              <div className="profile-fields-compact">
                <div className="field-group-compact">
                  <label>ID</label>
                  <span>{selectedChat.customerId}</span>
                </div>
                <div className="field-group-compact">
                  <label>Îã¥ÎãπÏûê</label>
                  <span>{user.name}</span>
                </div>
              </div>

              <div className="profile-actions-compact">
                {/* <button className="btn btn-secondary btn-small">ÎÖ∏Ìä∏</button> */}
                <button className="btn btn-primary btn-small">ÏÉÅÎã¥ ÏôÑÎ£å</button>
              </div>
            </div>

            {/* AI Ï±ÑÌåÖ ÏòÅÏó≠ */}
            <div className="ai-chat-section">
              <div className="ai-chat-header">
                <h5>ü§ñ AI ÏÉÅÎã¥ ÎèÑÏö∞ÎØ∏</h5>
                <span className="ai-status">Ïò®ÎùºÏù∏</span>
              </div>

              <div className="ai-chat-messages">
                {aiChatHistory.length === 0 ? (
                  <div className="ai-welcome">
                    <p>ÏÉÅÎã¥Ïóê ÎèÑÏõÄÏù¥ ÌïÑÏöîÌïòÏãúÎ©¥ Ïñ∏Ï†úÎì† AIÏóêÍ≤å ÏßàÎ¨∏ÌïòÏÑ∏Ïöî.</p>
                  </div>
                ) : (
                  aiChatHistory.map((message) => (
                    <div
                      key={message.id}
                      className={`ai-message ${
                        message.sender === "user" ? "user" : "ai"
                      }`}
                    >
                      <div className="ai-message-content">
                        <p>{message.content}</p>
                        <span className="ai-message-time">
                          {message.timestamp}
                        </span>
                      </div>
                    </div>
                  ))
                )}
              </div>

              <div className="ai-chat-input">
                <input
                  type="text"
                  className="ai-input"
                  placeholder="AIÏóêÍ≤å ÏßàÎ¨∏ÌïòÍ∏∞..."
                  value={aiMessage}
                  onChange={(e) => setAiMessage(e.target.value)}
                  onKeyPress={(e) => e.key === "Enter" && handleSendAiMessage()}
                />
                <button
                  className="ai-send-button"
                  onClick={handleSendAiMessage}
                  disabled={!aiMessage.trim()}
                >
                  üì§
                </button>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Í≥†Í∞ù Ï†ïÎ≥¥ Î™®Îã¨ */}
      <CustomerInfoModal
        isOpen={isCustomerModalOpen}
        onClose={() => setIsCustomerModalOpen(false)}
        customerData={selectedChat}
      />
    </div>
  );
};

export default ConsultationPage;
